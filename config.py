# -*- coding: utf-8 -*-
"""
GENESIS SYSTEM CONFIGURATION
============================
Центральный файл настройки параметров системы.
Оптимизирован для моделей с контекстным окном 16k (16384 токена).
"""

import os
import logging
from dataclasses import dataclass, field
from typing import List

# Настройка базового логгера для конфига
logger = logging.getLogger("GenesisConfig")

@dataclass
class SystemConfig:
    """
    Глобальная конфигурация поведения агентов и инструментов.
    """

    # ==========================================================================
    # 1. ПОДКЛЮЧЕНИЕ К LLM (НЕЙРОСЕТИ)
    # ==========================================================================
    
    # Базовый URL API (совместим с OpenAI, LM Studio, vLLM, Ollama)
    LLM_BASE_URL: str = "http://localhost:1234/v1"
    
    # API-ключ. Для локальных серверов (LM Studio) обычно подходит любая строка.
    # Для реального OpenAI/DeepSeek замените на ваш настоящий ключ.
    LLM_API_KEY: str = "lm-studio"

    # Идентификаторы моделей (Model ID)
    # SMART: Используется для сложных задач (Архитектор, Писатель, Критик)
    MODEL_SMART_ID: str = "local-model"  
    # FAST: Используется для быстрых утилит (форматирование, классификация)
    MODEL_FAST_ID: str = "local-model"   
    
    # Настройки уведомлений в Telegram (Оставьте пустым, чтобы отключить)
    TG_BOT_TOKEN: str = "" 
    TG_CHAT_ID: str = ""  

    # ==========================================================================
    # 2. БЮДЖЕТ ТОКЕНОВ И ГЕНЕРАЦИЯ (OPTIMIZED FOR 16K)

    # ⚠️ ВАЖНОЕ ПРИМЕЧАНИЕ О МАСШТАБИРОВАНИИ (SCALING NOTE)
    # Текущие значения переменных (Limits) математически рассчитаны и оптимизированы
    # для моделей с контекстным окном 16k (16384 токена). Это "Золотой стандарт",
    # гарантирующий отсутствие ошибок переполнения памяти (Context Exceeded).
    # ЕСЛИ ВЫ ИСПОЛЬЗУЕТЕ МОДЕЛЬ С БОЛЬШИМ ОКНОМ (32k, 128k и т.д.):
    # 1. Увеличьте `CONTEXT_WINDOW_SIZE` до реального лимита вашей модели.
    # 2. Вы можете пропорционально увеличить "Бюджет внимания" агентов:
    #    -> `WRITER_EVIDENCE_CHUNK_SIZE` (чтобы учитывать больше фактов за раз)
    #    -> `WRITER_MAX_CONTEXT_CHARS`   (чтобы помнить больше предыдущих глав)
    #    -> `MAX_CONTENT_LENGTH_FOR_ANALYSIS` (чтобы читать огромные статьи целиком)
    # Пример: Для модели 32k можно смело умножать эти лимиты на 2.
    # ==============================================================================

    # [HARD LIMIT] Размер контекстного окна модели.
    # 16384 токена ≈ 40-50 тысяч знаков текста.
    CONTEXT_WINDOW_SIZE: int = 16384
    
    # Резерв токенов на ОТВЕТ модели.
    # 4096 токенов ≈ 12-15 тысяч знаков (очень длинная глава).
    # Уменьшение этого значения может привести к обрыву текста на полуслове.
    MAX_OUTPUT_TOKENS: int = 4096

    # --- Устойчивость (Retry Policy) ---
    # Количество попыток перезапуска при сбое генерации или сетевой ошибке.
    MAX_LLM_RETRIES: int = 3
    # Пауза перед повторной попыткой (сек). Увеличивается экспоненциально.
    RETRY_DELAY_BASE: float = 2.0

    # ==========================================================================
    # 3. НАСТРОЙКИ АГЕНТОВ (ТОНКАЯ НАСТРОЙКА ИНТЕЛЛЕКТА)
    # ==========================================================================

    # --- АРХИТЕКТОР (Планирование) ---
    # Целевое количество глав в документе.
    TARGET_CHAPTER_COUNT: int = 3

    # --- ИССЛЕДОВАТЕЛЬ (Поиск и анализ) ---
    # Количество открываемых ссылок на один поисковый запрос.
    # 2 — оптимальный баланс между скоростью и глубиной для 16k.
    SEARCH_NUMBER: int = 2          

    # Количество поисковых запросов на одну главу.
    QUERIES_PER_CHAPTER: int = 2    

    # Максимальная длина текста с веб-страницы для анализа (в символах).
    # ~22000 знаков ≈ 8000 токенов. Влезает в память исследователя.
    MAX_CONTENT_LENGTH_FOR_ANALYSIS: int = 22000 
    
    # --- ПИСАТЕЛЬ (Генерация контента) ---
    # Самая сложная часть: распределение бюджета токенов для Писателя.
    # Доступно на вход: ~11000 токенов (~28000 символов).

    # 1. ФАКТЫ (Evidence): Данные из интернета и графа знаний.
    # ~15000 символов. Это позволяет модели видеть много деталей.
    WRITER_EVIDENCE_CHUNK_SIZE: int = 15000    

    # 2. ПАМЯТЬ (Context): Краткое содержание предыдущих глав.
    # ~8000 символов. Достаточно, чтобы помнить сюжетную линию.
    WRITER_MAX_CONTEXT_CHARS: int = 8000      

    # Минимальная длина главы (символов). Если меньше — считается браком.
    WRITER_MIN_TEXT_LENGTH: int = 300         
    
    # Креативность (Temperature): 0.0 - робот, 1.0 - хаос.
    TEMP_CREATIVE: float = 0.7   # Для написания текста (баланс)
    TEMP_ANALYTICAL: float = 0.4 # Для работы с фактами (строгость)
    
    # --- КРИТИК (Редактура) ---
    # Объем текста главы, который критик видит за один раз.
    # 12500 символов ≈ 4500 токенов. Покрывает даже очень большие главы.
    CRITIC_INPUT_MAX_CHARS: int = 12500
    
    # ==========================================================================
    # 4. ИНСТРУМЕНТЫ И СЕТЬ (TOOLS & NETWORK)
    # ==========================================================================
    
    # Таймаут ожидания ответа от сайта (сек).
    HTTP_TIMEOUT: int = 20               
    
    # Время жизни кэша (в часах). Позволяет экономить трафик и время.
    CACHE_TTL_HOURS: int = 24            
    
    # Ограничение частоты запросов (защита от бана IP).
    RATE_LIMIT_CALLS_PER_MINUTE: int = 20

    # ==========================================================================
    # 5. МАСКИРОВКА (STEALTH & USER AGENTS)
    # ==========================================================================
    
    # Список User-Agent для имитации реальных браузеров.
    # Используется для обхода простых защит от ботов.
    USER_AGENTS: List[str] = field(default_factory=lambda: [
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36",
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:124.0) Gecko/20100101 Firefox/124.0",
        "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
    ])

    # Список рефереров (откуда мы якобы пришли на сайт).
    REFERERS: List[str] = field(default_factory=lambda: [
        "https://www.google.com/",
        "https://www.bing.com/",
        "https://yandex.ru/",
        "https://duckduckgo.com/"
    ])

    # ==========================================================================
    # 6. ФАЙЛОВАЯ СИСТЕМА
    # ==========================================================================
    
    LOG_DIR: str = "genesis_logs"           # Технические логи
    THOUGHT_DIR: str = "genesis_thoughts"   # "Мысли" агентов (цепочки рассуждений)
    WORK_DIR: str = "genesis_workspace"     # Временные файлы и скрипты
    ARTIFACTS_DIR: str = "genesis_artifacts" # Итоговые документы (DOCX)

    # Внутреннее поле для состояния Telegram (вычисляется автоматически)
    telegram_enabled: bool = field(init=False, repr=False)
    
    def __post_init__(self):
        """
        Инициализация конфигурации: создание папок и проверка токенов.
        """
        # 1. Создание рабочей структуры папок
        for path in [self.LOG_DIR, self.THOUGHT_DIR, self.WORK_DIR, self.ARTIFACTS_DIR]:
            try:
                os.makedirs(path, exist_ok=True)
            except OSError as e:
                logger.error(f"Не удалось создать директорию {path}: {e}")

        # 2. Проверка статуса Telegram бота
        # Бот считается активным, только если токены заполнены и не содержат дефолтных значений.
        self.telegram_enabled = bool(
            self.TG_BOT_TOKEN and 
            "ТВОЙ" not in self.TG_BOT_TOKEN.upper() and
            self.TG_CHAT_ID and 
            "ТВОЙ" not in self.TG_CHAT_ID.upper()
        )
        
        status_msg = "ВКЛЮЧЕНЫ" if self.telegram_enabled else "ОТКЛЮЧЕНЫ (Токен не задан)"
        logger.info(f"GENESIS CONFIG LOADED. Уведомления Telegram: {status_msg}")

# Создание глобального экземпляра конфигурации
CONFIG = SystemConfig()